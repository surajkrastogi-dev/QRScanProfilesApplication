<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>User Profile</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"/>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css" rel="stylesheet"/>

  <style>
    body{ background: linear-gradient(135deg,#f4f7ff,#fff); min-height: 100vh; }
    .glass-card{
      background: rgba(255,255,255,0.88);
      border: 1px solid rgba(0,0,0,0.06);
      box-shadow: 0 12px 35px rgba(0,0,0,0.12);
      border-radius: 18px;
    }
    .avatar{
      width: 90px; height: 90px; border-radius: 50%;
      display:flex; align-items:center; justify-content:center;
      font-size: 38px; color: white;
      background: linear-gradient(135deg, #1a73e8, #7c3aed);
      box-shadow: 0 10px 25px rgba(26,115,232,0.35);
    }
    .info-row{
      background: #fff;
      border: 1px solid rgba(0,0,0,0.06);
      border-radius: 14px;
      padding: 14px;
    }
    .qr-box{
      background: #fff;
      border-radius: 16px;
      border: 1px dashed rgba(0,0,0,0.15);
      padding: 18px;
      text-align: center;
    }
    .qr-img{
      width: 220px; height: 220px;
      border-radius: 14px;
      border: 1px solid rgba(0,0,0,0.08);
      padding: 8px;
      background: #fff;
    }
    .muted-sm{ color:#6c757d; font-size: 13px; }
  </style>
</head>

<body>
<div class="container py-5">
  <div class="row justify-content-center">
    <div class="col-lg-10">

      <div class="glass-card p-4">
        <div class="row g-4">

          <!-- LEFT -->
          <div class="col-lg-7">
            <div class="d-flex align-items-center gap-3 mb-4">
              <div class="avatar"><i class="bi bi-person-fill"></i></div>
              <div class="flex-grow-1">
                <h3 class="mb-1 fw-bold" th:text="${user.userName}">User Name</h3>
                <div class="muted-sm">
                  <i class="bi bi-qr-code-scan me-1"></i> Opened via QR Scan
                </div>
              </div>
            </div>

            <div class="row g-3">
              <div class="col-12">
                <div class="info-row">
                  <div class="muted-sm mb-1"><i class="bi bi-envelope-at me-1"></i>Email</div>
                  <div class="fw-semibold" th:text="${user.userEmail}" id="emailValue"></div>
                </div>
              </div>

              <div class="col-12">
                <div class="info-row">
                  <div class="muted-sm mb-1"><i class="bi bi-telephone me-1"></i>Mobile</div>
                  <div class="fw-semibold" th:text="${user.mobile}" id="mobileValue"></div>
                </div>
              </div>

              <div class="col-12">
                <div class="info-row">
                  <div class="muted-sm mb-1"><i class="bi bi-link-45deg me-1"></i>Profile Link</div>
                  <div class="fw-semibold text-break" th:text="${url}" id="urlValue"></div>

                  <div class="mt-2 d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-dark btn-sm" onclick="copyUrl()">
                      <i class="bi bi-clipboard-check me-1"></i>Copy Link
                    </button>

                    <a class="btn btn-success btn-sm" th:href="'https://wa.me/91' + ${user.mobile}" target="_blank">
                      <i class="bi bi-whatsapp me-1"></i>WhatsApp
                    </a>

                    <a class="btn btn-primary btn-sm" th:href="'tel:' + ${user.mobile}">
                      <i class="bi bi-telephone-outbound me-1"></i>Call
                    </a>

                    <a class="btn btn-warning btn-sm" th:href="'mailto:' + ${user.userEmail}">
                      <i class="bi bi-envelope me-1"></i>Email
                    </a>
                  </div>
                </div>
              </div>

              <div class="col-12">
                <div class="info-row">
                  <div class="muted-sm mb-1"><i class="bi bi-hourglass-split me-1"></i>Token Expiry Countdown</div>
                  <div class="fw-bold" id="countdown">Loading...</div>
                  <div class="muted-sm mt-1">
                    <i class="bi bi-info-circle me-1"></i>One-time QR token ✅
                  </div>
                  <span id="expiryTime" th:text="${expiryTime}" style="display:none;"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- RIGHT -->
          <div class="col-lg-5">
            <div class="qr-box">
              <h5 class="fw-bold mb-2"><i class="bi bi-qr-code me-1"></i> QR Code</h5>

              <img class="qr-img" th:src="'data:image/png;base64,' + ${qrBase64}" alt="QR"/>

              <div class="mt-3 d-grid gap-2">
                <button class="btn btn-primary" onclick="downloadQr()">
                  <i class="bi bi-download me-1"></i>Download QR
                </button>

                <button class="btn btn-light border" onclick="window.print()">
                  <i class="bi bi-printer me-1"></i>Print Page
                </button>
              </div>

              <div class="mt-3 muted-sm">
                <i class="bi bi-lock me-1"></i>Token-based secure sharing ✅
              </div>
            </div>
          </div>

        </div>

        <div class="d-flex justify-content-between align-items-center mt-4 flex-wrap gap-2">
          <a href="/" class="btn btn-light border px-4">
            <i class="bi bi-arrow-left me-1"></i> Back
          </a>
          <span class="muted-sm">
            <i class="bi bi-lightning-charge me-1"></i> Spring Boot + Thymeleaf ✅
          </span>
        </div>

      </div>

    </div>
  </div>
</div>

<script>
  function copyUrl(){
    const text = document.getElementById("urlValue").innerText;
    navigator.clipboard.writeText(text).then(() => alert("Profile link copied ✅"));
  }

  function downloadQr(){
    const img = document.querySelector(".qr-img");
    const link = document.createElement("a");
    link.href = img.src;
    link.download = "user-qr.png";
    link.click();
  }

  // ✅ Expiry countdown
  function startCountdown(){
    const expiryText = document.getElementById("expiryTime").innerText;
    const expiryDate = new Date(expiryText);

    const timer = setInterval(() => {
      const now = new Date();
      const diff = expiryDate - now;

      if(diff <= 0){
        document.getElementById("countdown").innerText = "Expired ❌";
        clearInterval(timer);
        return;
      }

      const minutes = Math.floor(diff / (1000 * 60));
      const seconds = Math.floor((diff % (1000 * 60)) / 1000);

      document.getElementById("countdown").innerText = `${minutes} min ${seconds} sec`;
    }, 1000);
  }

  startCountdown();
</script>

</body>
</html>
